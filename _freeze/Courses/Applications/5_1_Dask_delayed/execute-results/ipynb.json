{
  "hash": "bdce28e55c4dd1707b7810112dbb68e4",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Dask `delayed` App\"\n---\n\n\n<img src=\"https://docs.dask.org/en/latest/_images/dask_horizontal.svg\"\n     align=\"right\"\n     width=\"30%\"\n     alt=\"Dask logo\\\">\n\n# dask.delayed - parallelize any code\n\nWhat if you don't have an array or dataframe? Instead of having blocks where the function is applied to each block, you can decorate functions with `@delayed` and _have the functions themselves be lazy_. \n\nThis is a simple way to use `dask` to parallelize existing codebases or build [complex systems](https://blog.dask.org/2018/02/09/credit-models-with-dask). \n\n**Related Documentation**\n\n* [Delayed documentation](https://docs.dask.org/en/latest/delayed.html)\n* [Delayed screencast](https://www.youtube.com/watch?v=SHqFmynRxVU)\n* [Delayed API](https://docs.dask.org/en/latest/delayed-api.html)\n* [Delayed examples](https://examples.dask.org/delayed.html)\n* [Delayed best practices](https://docs.dask.org/en/latest/delayed-best-practices.html)\n\nAs we'll see in the [distributed scheduler notebook](05_distributed.ipynb), Dask has several ways of executing code in parallel. We'll use the distributed scheduler by creating a `dask.distributed.Client`. For now, this will provide us with some nice diagnostics. We'll talk about schedulers in depth later.\n\n### Iniatilization of the ipyparallel/dask interface\n\n::: {#63576d7e .cell execution_count=1}\n``` {.python .cell-code}\nfrom ipyparallel import Client\n\n### Force the 8 nodes/1 core layout\nrc = Client()\nrc.stop_distributed()\nclient = rc.become_dask()\nclient\n```\n\n::: {.cell-output .cell-output-display execution_count=1}\n```{=html}\n<div>\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\"> </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px;\">Client</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Client-175c63bd-7994-11ef-aec4-7cd30ab80090</p>\n        <table style=\"width: 100%; text-align: left;\">\n\n        <tr>\n        \n            <td style=\"text-align: left;\"><strong>Connection method:</strong> Direct</td>\n            <td style=\"text-align: left;\"></td>\n        \n        </tr>\n\n        \n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard: </strong> <a href=\"http://10.30.0.190:8787/status\" target=\"_blank\">http://10.30.0.190:8787/status</a>\n                </td>\n                <td style=\"text-align: left;\"></td>\n            </tr>\n        \n\n        </table>\n\n        \n            <button style=\"margin-bottom: 12px;\" data-commandlinker-command=\"dask:populate-and-launch-layout\" data-commandlinker-args='{\"url\": \"http://10.30.0.190:8787/status\" }'>\n                Launch dashboard in JupyterLab\n            </button>\n        \n\n        \n            <details>\n            <summary style=\"margin-bottom: 20px;\"><h3 style=\"display: inline;\">Scheduler Info</h3></summary>\n            <div style=\"\">\n    <div>\n        <div style=\"width: 24px; height: 24px; background-color: #FFF7E5; border: 3px solid #FF6132; border-radius: 5px; position: absolute;\"> </div>\n        <div style=\"margin-left: 48px;\">\n            <h3 style=\"margin-bottom: 0px;\">Scheduler</h3>\n            <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Scheduler-c53688bc-5e44-4d28-8904-bdfdaae274a1</p>\n            <table style=\"width: 100%; text-align: left;\">\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Comm:</strong> tcp://10.30.0.190:21673\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Workers:</strong> 7\n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Dashboard:</strong> <a href=\"http://10.30.0.190:8787/status\" target=\"_blank\">http://10.30.0.190:8787/status</a>\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total threads:</strong> 7\n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Started:</strong> Just now\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total memory:</strong> 28.00 GiB\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n\n    <details style=\"margin-left: 48px;\">\n        <summary style=\"margin-bottom: 20px;\">\n            <h3 style=\"display: inline;\">Workers</h3>\n        </summary>\n\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: tcp://10.30.0.191:14782</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://10.30.0.191:14782\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://10.30.0.191:10695/status\" target=\"_blank\">http://10.30.0.191:10695/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 4.00 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> None\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-tus1xqtv\n                        </td>\n                    </tr>\n\n                    \n\n                    \n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks executing: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in memory: </strong> \n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks ready: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in flight: </strong>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>CPU usage:</strong> 0.0%\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Last seen: </strong> Just now\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory usage: </strong> 91.58 MiB\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Spilled bytes: </strong> 0 B\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Read bytes: </strong> 0.0 B\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Write bytes: </strong> 0.0 B\n                        </td>\n                    </tr>\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: tcp://10.30.0.193:14151</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://10.30.0.193:14151\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://10.30.0.193:30505/status\" target=\"_blank\">http://10.30.0.193:30505/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 4.00 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> None\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-_0sybwfl\n                        </td>\n                    </tr>\n\n                    \n\n                    \n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks executing: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in memory: </strong> \n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks ready: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in flight: </strong>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>CPU usage:</strong> 0.0%\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Last seen: </strong> Just now\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory usage: </strong> 91.61 MiB\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Spilled bytes: </strong> 0 B\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Read bytes: </strong> 0.0 B\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Write bytes: </strong> 0.0 B\n                        </td>\n                    </tr>\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: tcp://10.30.0.194:10182</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://10.30.0.194:10182\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://10.30.0.194:16940/status\" target=\"_blank\">http://10.30.0.194:16940/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 4.00 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> None\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-4grhlh1m\n                        </td>\n                    </tr>\n\n                    \n\n                    \n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks executing: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in memory: </strong> \n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks ready: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in flight: </strong>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>CPU usage:</strong> 0.0%\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Last seen: </strong> Just now\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory usage: </strong> 93.43 MiB\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Spilled bytes: </strong> 0 B\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Read bytes: </strong> 0.0 B\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Write bytes: </strong> 0.0 B\n                        </td>\n                    </tr>\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: tcp://10.30.0.195:6891</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://10.30.0.195:6891\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://10.30.0.195:29826/status\" target=\"_blank\">http://10.30.0.195:29826/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 4.00 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> None\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-zg3g9eag\n                        </td>\n                    </tr>\n\n                    \n\n                    \n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks executing: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in memory: </strong> \n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks ready: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in flight: </strong>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>CPU usage:</strong> 0.0%\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Last seen: </strong> Just now\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory usage: </strong> 94.94 MiB\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Spilled bytes: </strong> 0 B\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Read bytes: </strong> 0.0 B\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Write bytes: </strong> 0.0 B\n                        </td>\n                    </tr>\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: tcp://10.30.0.196:28382</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://10.30.0.196:28382\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://10.30.0.196:15264/status\" target=\"_blank\">http://10.30.0.196:15264/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 4.00 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> None\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-qj62rsqv\n                        </td>\n                    </tr>\n\n                    \n\n                    \n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks executing: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in memory: </strong> \n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks ready: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in flight: </strong>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>CPU usage:</strong> 0.0%\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Last seen: </strong> Just now\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory usage: </strong> 96.48 MiB\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Spilled bytes: </strong> 0 B\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Read bytes: </strong> 0.0 B\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Write bytes: </strong> 0.0 B\n                        </td>\n                    </tr>\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: tcp://10.30.0.197:14664</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://10.30.0.197:14664\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://10.30.0.197:24139/status\" target=\"_blank\">http://10.30.0.197:24139/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 4.00 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> None\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-37e1c_y2\n                        </td>\n                    </tr>\n\n                    \n\n                    \n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks executing: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in memory: </strong> \n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks ready: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in flight: </strong>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>CPU usage:</strong> 0.0%\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Last seen: </strong> Just now\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory usage: </strong> 95.73 MiB\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Spilled bytes: </strong> 0 B\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Read bytes: </strong> 0.0 B\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Write bytes: </strong> 0.0 B\n                        </td>\n                    </tr>\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: tcp://10.30.0.198:9310</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://10.30.0.198:9310\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://10.30.0.198:22985/status\" target=\"_blank\">http://10.30.0.198:22985/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 4.00 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> None\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-6941h681\n                        </td>\n                    </tr>\n\n                    \n\n                    \n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks executing: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in memory: </strong> \n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks ready: </strong> \n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Tasks in flight: </strong>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>CPU usage:</strong> 0.0%\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Last seen: </strong> Just now\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory usage: </strong> 96.55 MiB\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Spilled bytes: </strong> 0 B\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Read bytes: </strong> 0.0 B\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Write bytes: </strong> 0.0 B\n                        </td>\n                    </tr>\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n\n    </details>\n</div>\n            </details>\n        \n\n    </div>\n</div>\n```\n:::\n:::\n\n\n## A Typical Workflow\n\nTypically if a workflow contains a for-loop it can benefit from delayed. The following example outlines a read-transform-write:\n\n```python\nimport dask\n    \n@dask.delayed\ndef process_file(filename):\n    data = read_a_file(filename)\n    data = do_a_transformation(data)\n    destination = f\"results/{filename}\"\n    write_out_data(data, destination)\n    return destination\n\nresults = []\nfor filename in filenames:\n    results.append(process_file(filename))\n    \ndask.compute(results)\n```\n\n## Basics\n\nFirst let's make some toy functions, `inc` and `add`, that sleep for a while to simulate work. We'll then time running these functions normally.\n\nIn the next section we'll parallelize this code.\n\n::: {#5b54bffa .cell execution_count=2}\n``` {.python .cell-code}\nfrom time import sleep\n\n\ndef inc(x):\n    sleep(1)\n    return x + 1\n\n\ndef add(x, y):\n    sleep(1)\n    return x + y\n```\n:::\n\n\nWe time the execution of this normal code using the `%%time` magic, which is a special function of the Jupyter Notebook.\n\n::: {#79f33cb8 .cell execution_count=3}\n``` {.python .cell-code}\n%%time\n# This takes three seconds to run because we call each\n# function sequentially, one after the other\n\nx = inc(1)\ny = inc(2)\nz = add(x, y) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCPU times: user 1.72 ms, sys: 65 μs, total: 1.79 ms\nWall time: 3 s\n```\n:::\n:::\n\n\n### Parallelize with the `dask.delayed` decorator\n\nThose two increment calls *could* be called in parallel, because they are totally independent of one-another.\n\nWe'll make the `inc` and `add` functions lazy using the `dask.delayed` decorator. When we call the delayed version by passing the arguments, exactly as before, the original function isn't actually called yet - which is why the cell execution finishes very quickly.\nInstead, a *delayed object* is made, which keeps track of the function to call and the arguments to pass to it.\n\n::: {#8fe1497f .cell execution_count=4}\n``` {.python .cell-code}\nimport dask\n\n\n@dask.delayed\ndef inc(x):\n    sleep(1)\n    return x + 1\n\n\n@dask.delayed\ndef add(x, y):\n    sleep(1)\n    return x + y\n```\n:::\n\n\n::: {#fafcb63b .cell execution_count=5}\n``` {.python .cell-code}\n%%time\n# This runs immediately, all it does is build a graph\n\nx = inc(1)\ny = inc(2)\nz = add(x, y)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCPU times: user 345 μs, sys: 0 ns, total: 345 μs\nWall time: 281 μs\n```\n:::\n:::\n\n\nThis ran immediately, since nothing has really happened yet.\n\nTo get the result, call `compute`. Notice that this runs faster than the original code.\n\n::: {#1975e888 .cell execution_count=6}\n``` {.python .cell-code}\n%%time\n# This actually runs our computation using a local thread pool\n\nz.compute()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCPU times: user 4.01 ms, sys: 0 ns, total: 4.01 ms\nWall time: 2.01 s\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=6}\n```\n5\n```\n:::\n:::\n\n\n## What just happened?\n\nThe `z` object is a lazy `Delayed` object.  This object holds everything we need to compute the final result, including references to all of the functions that are required and their inputs and relationship to one-another.  We can evaluate the result with `.compute()` as above or we can visualize the task graph for this value with `.visualize()`.\n\n::: {#3d634f20 .cell execution_count=7}\n``` {.python .cell-code}\nz\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n```\nDelayed('add-d09cc81f-e395-48eb-82e8-159a14304ebf')\n```\n:::\n:::\n\n\n::: {#9c1a89b9 .cell execution_count=8}\n``` {.python .cell-code}\n# Look at the task graph for `z`\nz.visualize()\n```\n\n::: {.cell-output .cell-output-display execution_count=8}\n![](5_1_Dask_delayed_files/figure-ipynb/cell-9-output-1.png){}\n:::\n:::\n\n\nNotice that this includes the names of the functions from before, and the logical flow of the outputs of the `inc` functions to the inputs of `add`.\n\n### Some questions to consider:\n\n-  Why did we go from 3s to 2s?  Why weren't we able to parallelize down to 1s?\n-  What would have happened if the inc and add functions didn't include the `sleep(1)`?  Would Dask still be able to speed up this code?\n-  What if we have multiple outputs or also want to get access to x or y?\n\n## Exercise: Parallelize a for loop\n\n`for` loops are one of the most common things that we want to parallelize.  Use `dask.delayed` on `inc` and `sum` to parallelize the computation below:\n\n::: {#e989de88 .cell execution_count=9}\n``` {.python .cell-code}\ndata = [1, 2, 3, 4, 5, 6, 7, 8] \n```\n:::\n\n\n::: {#157cf7f4 .cell execution_count=10}\n``` {.python .cell-code}\n%%time\n# Sequential code\n\n\ndef inc(x):\n    sleep(1)\n    return x + 1\n\n\nresults = []\nfor x in data:\n    y = inc(x)\n    results.append(y)\n\ntotal = sum(results)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCPU times: user 3.48 ms, sys: 0 ns, total: 3.48 ms\nWall time: 8 s\n```\n:::\n:::\n\n\n::: {#4fdb48a4 .cell execution_count=11}\n``` {.python .cell-code}\ntotal\n```\n\n::: {.cell-output .cell-output-display execution_count=11}\n```\n44\n```\n:::\n:::\n\n\n::: {#a7eb30ed .cell execution_count=12}\n``` {.python .cell-code}\n%%time\n# Your parallel code here...\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCPU times: user 0 ns, sys: 0 ns, total: 0 ns\nWall time: 4.77 μs\n```\n:::\n:::\n\n\n::: {#78e1cbc9 .cell tags='[\"solution\"]' execution_count=13}\n``` {.python .cell-code}\n%%time\n\n@dask.delayed\ndef inc(x):\n    sleep(1)\n    return x + 1\n\n\nresults = []\nfor x in data:\n    y = inc(x)\n    results.append(y)\n\ntotal = dask.delayed(sum)(results)\nprint(\"Before computing:\", total)  # Let's see what type of thing total is\nresult = total.compute()\nprint(\"After computing :\", result)  # After it's computed\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nBefore computing: Delayed('sum-11af865c-3b2d-48d9-bf3a-241ed8fecae1')\nAfter computing : 44\nCPU times: user 4.49 ms, sys: 0 ns, total: 4.49 ms\nWall time: 1.02 s\n```\n:::\n:::\n\n\nHow do the graph visualizations compare with the given solution, compared to a version with the `sum` function used directly rather than wrapped with `delayed`? Can you explain the latter version? You might find the result of the following expression illuminating\n```python\ninc(1) + inc(2)\n```\n\n::: {#27c5ad2b .cell tags='[\"solution\"]' execution_count=14}\n``` {.python .cell-code}\n(inc(1) + inc(2)).visualize()\n```\n\n::: {.cell-output .cell-output-display execution_count=14}\n![](5_1_Dask_delayed_files/figure-ipynb/cell-15-output-1.png){}\n:::\n:::\n\n\n::: {#424ff72a .cell tags='[\"solution\"]' execution_count=15}\n``` {.python .cell-code}\nsum([inc(1),inc(2),inc(3)]).visualize()\n```\n\n::: {.cell-output .cell-output-display execution_count=15}\n![](5_1_Dask_delayed_files/figure-ipynb/cell-16-output-1.png){}\n:::\n:::\n\n\n::: {#74f26377 .cell tags='[\"solution\"]' execution_count=16}\n``` {.python .cell-code}\ntotal.visualize()\n```\n\n::: {.cell-output .cell-output-display execution_count=16}\n![](5_1_Dask_delayed_files/figure-ipynb/cell-17-output-1.png){}\n:::\n:::\n\n\n## Putting it all together with a the producer-consumer pattern\n\n## Introduction with a simple producer-consumer example\n\nWe’ll try to reproduce the producer/consumer code from asynchronous application with `asyncio` or `threading` but with `dask.delayed` and compute\n\n```python\nfrom dask import delayed, compute\nfrom dask.distributed import Queue, print\nfrom time import sleep\n\nqueue = Queue()\n...\n```\n\n::: {#f7be50d8 .cell tags='[\"solution\"]' execution_count=17}\n``` {.python .cell-code}\nfrom dask import delayed, compute\nfrom dask.distributed import Queue, print\nfrom time import sleep\n\nqueue = Queue()\n\n@delayed\ndef produce(queue, n):\n    print(\"producing {} items\".format(n))\n    for x in range(1, n + 1):\n        # simulate i/o operation using sleep\n        sleep(1)\n        # produce an item\n        print(\"producing {}/{}\".format(x, n))\n        item = str(x)\n        # put the item in the queue\n        queue.put(item)\n\n    # indicate the producer is done\n    queue.put(None)\n    return n\n\n@delayed\ndef consume(queue):\n    consumed = 0\n    print(\"consuming items\")\n    while True:\n        # wait for an item from the producer\n        item = queue.get()\n        if item is None:\n            # the producer emits None to indicate that it is done\n            break\n\n        # process the item\n        print(\"consuming {}\".format(item))\n        consumed += 1\n    return consumed\n\ncompute(\n    produce(queue, 5), \n    consume(queue)\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=17}\n```\n(5, 5)\n```\n:::\n:::\n\n\n## Exercise: Parallelize a for-loop code with control flow\n\nOften we want to delay only *some* functions, running a few of them immediately.  This is especially helpful when those functions are fast and help us to determine what other slower functions we should call.  This decision, to delay or not to delay, is usually where we need to be thoughtful when using `dask.delayed`.\n\nIn the example below we iterate through a list of inputs.  If that input is even then we want to call `inc`.  If the input is odd then we want to call `double`.  This `is_even` decision to call `inc` or `double` has to be made immediately (not lazily) in order for our graph-building Python code to proceed.\n\n::: {#7197691c .cell execution_count=18}\n``` {.python .cell-code}\ndef double(x):\n    sleep(1)\n    return 2 * x\n\ndef inc(x):\n    sleep(1)\n    return x + 1\n\ndef is_even(x):\n    return not x % 2\n\n\ndata = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]\n```\n:::\n\n\n::: {#42c54c8f .cell execution_count=19}\n``` {.python .cell-code}\n%%time\n# Sequential code\n\nresults = []\nfor x in data:\n    if is_even(x):\n        y = double(x)\n    else:\n        y = inc(x)\n    results.append(y)\n\ntotal = sum(results)\nprint(total)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n90\nCPU times: user 4.22 ms, sys: 197 μs, total: 4.42 ms\nWall time: 10 s\n```\n:::\n:::\n\n\n```python\n%%time\n# Your parallel code here...\n# TODO: parallelize the sequential code above using dask.delayed\n# You will need to delay some functions, but not all\n```\n\n::: {#8e41c82e .cell tags='[\"solution\"]' execution_count=20}\n``` {.python .cell-code}\n@dask.delayed\ndef double(x):\n    sleep(1)\n    return 2 * x\n\n@dask.delayed\ndef inc(x):\n    sleep(1)\n    return x + 1\n\nresults = []\nfor x in data:\n    if is_even(x):  # even\n        y = double(x)\n    else:  # odd\n        y = inc(x)\n    results.append(y)\n\ntotal = sum(results)\n```\n:::\n\n\n::: {#d21089eb .cell tags='[\"solution\"]' execution_count=21}\n``` {.python .cell-code}\n%time total.compute()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCPU times: user 3.84 ms, sys: 71 μs, total: 3.91 ms\nWall time: 2.02 s\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=21}\n```\n90\n```\n:::\n:::\n\n\n::: {#49864272 .cell tags='[\"solution\"]' execution_count=22}\n``` {.python .cell-code}\ntotal.visualize()\n```\n\n::: {.cell-output .cell-output-display execution_count=22}\n![](5_1_Dask_delayed_files/figure-ipynb/cell-23-output-1.png){}\n:::\n:::\n\n\n### Some questions to consider:\n\n-  What are other examples of control flow where we can't use delayed?\n-  What would have happened if we had delayed the evaluation of `is_even(x)` in the example above?\n-  What are your thoughts on delaying `sum`?  This function is both computational but also fast to run.\n\n- Example of control flow with we can’t use delayed : conditional loops, recursive functions\n- Nothing, we have to compute it immediately for branching\n- Delaying sum isn’t worth the graph walk overload\n\n## Exercise: Parallelize a Pandas Groupby Reduction\n\nIn this exercise we read several CSV files and perform a groupby operation in parallel.  We are given sequential code to do this and parallelize it with `dask.delayed`.\n\nThe computation we will parallelize is to compute the mean departure delay per airport from some historical flight data.  We will do this by using `dask.delayed` together with `pandas`.  In a future section we will do this same exercise with `dask.dataframe`.\n\n## Create data\n\nRun this code to prep some data.\n\nThis downloads and extracts some historical flight data for flights out of NYC between 1990 and 2000. The data is originally from [here](http://stat-computing.org/dataexpo/2009/the-data.html).\n\n::: {#7aed2bb0 .cell execution_count=23}\n``` {.python .cell-code}\nimport os\nimport requests\n\nos.makedirs(\"data\", exist_ok=True)\ncode_url = \"https://raw.githubusercontent.com/dask/dask-tutorial/main/prep.py\"\nwith open(\"prep.py\", \"wb\") as f:\n    f.write(requests.get(code_url).content)\n%run prep.py -d flights\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n- Downloading NYC Flights dataset... done\n- Extracting flight data... \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n/lustre/collinf/miashs-2-advanced-programming-parallel-computing-2024-2025/Courses/Applications/prep.py:66: DeprecationWarning:\n\nPython 3.14 will, by default, filter extracted tar archives and reject files or modify their metadata. Use the filter argument to control this behavior.\n\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\ndone\n- Creating json data... done\n** Created flights dataset! in 5.74s**\n```\n:::\n:::\n\n\n### Inspect data\n\n::: {#a7b61479 .cell execution_count=24}\n``` {.python .cell-code}\nsorted(os.listdir(os.path.join(\"data\", \"nycflights\")))\n```\n\n::: {.cell-output .cell-output-display execution_count=24}\n```\n['1990.csv',\n '1991.csv',\n '1992.csv',\n '1993.csv',\n '1994.csv',\n '1995.csv',\n '1996.csv',\n '1997.csv',\n '1998.csv',\n '1999.csv']\n```\n:::\n:::\n\n\n### Read one file with `pandas.read_csv` and compute mean departure delay\n\n::: {#604c4ab1 .cell execution_count=25}\n``` {.python .cell-code}\nimport pandas as pd\n\ndf = pd.read_csv(os.path.join(\"data\", \"nycflights\", \"1990.csv\"))\ndf.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=25}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>Year</th>\n      <th>Month</th>\n      <th>DayofMonth</th>\n      <th>DayOfWeek</th>\n      <th>DepTime</th>\n      <th>CRSDepTime</th>\n      <th>ArrTime</th>\n      <th>CRSArrTime</th>\n      <th>UniqueCarrier</th>\n      <th>FlightNum</th>\n      <th>...</th>\n      <th>AirTime</th>\n      <th>ArrDelay</th>\n      <th>DepDelay</th>\n      <th>Origin</th>\n      <th>Dest</th>\n      <th>Distance</th>\n      <th>TaxiIn</th>\n      <th>TaxiOut</th>\n      <th>Cancelled</th>\n      <th>Diverted</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>1990</td>\n      <td>1</td>\n      <td>1</td>\n      <td>1</td>\n      <td>1621.0</td>\n      <td>1540</td>\n      <td>1747.0</td>\n      <td>1701</td>\n      <td>US</td>\n      <td>33</td>\n      <td>...</td>\n      <td>NaN</td>\n      <td>46.0</td>\n      <td>41.0</td>\n      <td>EWR</td>\n      <td>PIT</td>\n      <td>319.0</td>\n      <td>NaN</td>\n      <td>NaN</td>\n      <td>0</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>1990</td>\n      <td>1</td>\n      <td>2</td>\n      <td>2</td>\n      <td>1547.0</td>\n      <td>1540</td>\n      <td>1700.0</td>\n      <td>1701</td>\n      <td>US</td>\n      <td>33</td>\n      <td>...</td>\n      <td>NaN</td>\n      <td>-1.0</td>\n      <td>7.0</td>\n      <td>EWR</td>\n      <td>PIT</td>\n      <td>319.0</td>\n      <td>NaN</td>\n      <td>NaN</td>\n      <td>0</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>1990</td>\n      <td>1</td>\n      <td>3</td>\n      <td>3</td>\n      <td>1546.0</td>\n      <td>1540</td>\n      <td>1710.0</td>\n      <td>1701</td>\n      <td>US</td>\n      <td>33</td>\n      <td>...</td>\n      <td>NaN</td>\n      <td>9.0</td>\n      <td>6.0</td>\n      <td>EWR</td>\n      <td>PIT</td>\n      <td>319.0</td>\n      <td>NaN</td>\n      <td>NaN</td>\n      <td>0</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>1990</td>\n      <td>1</td>\n      <td>4</td>\n      <td>4</td>\n      <td>1542.0</td>\n      <td>1540</td>\n      <td>1710.0</td>\n      <td>1701</td>\n      <td>US</td>\n      <td>33</td>\n      <td>...</td>\n      <td>NaN</td>\n      <td>9.0</td>\n      <td>2.0</td>\n      <td>EWR</td>\n      <td>PIT</td>\n      <td>319.0</td>\n      <td>NaN</td>\n      <td>NaN</td>\n      <td>0</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>1990</td>\n      <td>1</td>\n      <td>5</td>\n      <td>5</td>\n      <td>1549.0</td>\n      <td>1540</td>\n      <td>1706.0</td>\n      <td>1701</td>\n      <td>US</td>\n      <td>33</td>\n      <td>...</td>\n      <td>NaN</td>\n      <td>5.0</td>\n      <td>9.0</td>\n      <td>EWR</td>\n      <td>PIT</td>\n      <td>319.0</td>\n      <td>NaN</td>\n      <td>NaN</td>\n      <td>0</td>\n      <td>0</td>\n    </tr>\n  </tbody>\n</table>\n<p>5 rows × 23 columns</p>\n</div>\n```\n:::\n:::\n\n\n::: {#7918165b .cell execution_count=26}\n``` {.python .cell-code}\n# What is the schema?\ndf.dtypes\n```\n\n::: {.cell-output .cell-output-display execution_count=26}\n```\nYear                   int64\nMonth                  int64\nDayofMonth             int64\nDayOfWeek              int64\nDepTime              float64\nCRSDepTime             int64\nArrTime              float64\nCRSArrTime             int64\nUniqueCarrier         object\nFlightNum              int64\nTailNum              float64\nActualElapsedTime    float64\nCRSElapsedTime         int64\nAirTime              float64\nArrDelay             float64\nDepDelay             float64\nOrigin                object\nDest                  object\nDistance             float64\nTaxiIn               float64\nTaxiOut              float64\nCancelled              int64\nDiverted               int64\ndtype: object\n```\n:::\n:::\n\n\n::: {#596d511b .cell execution_count=27}\n``` {.python .cell-code}\n# What originating airports are in the data?\ndf.Origin.unique()\n```\n\n::: {.cell-output .cell-output-display execution_count=27}\n```\narray(['EWR', 'LGA', 'JFK'], dtype=object)\n```\n:::\n:::\n\n\n::: {#83153ef2 .cell execution_count=28}\n``` {.python .cell-code}\n# Mean departure delay per-airport for one year\ndf.groupby(\"Origin\").DepDelay.mean()\n```\n\n::: {.cell-output .cell-output-display execution_count=28}\n```\nOrigin\nEWR     9.168411\nJFK    11.857274\nLGA     8.560045\nName: DepDelay, dtype: float64\n```\n:::\n:::\n\n\n### Sequential code: Mean Departure Delay Per Airport\n\nThe above cell computes the mean departure delay per-airport for one year. Here we expand that to all years using a sequential for loop.\n\n::: {#3cd100bc .cell execution_count=29}\n``` {.python .cell-code}\nfrom glob import glob\n\nfilenames = sorted(glob(os.path.join(\"data\", \"nycflights\", \"*.csv\")))\n```\n:::\n\n\n::: {#9b3178a6 .cell execution_count=30}\n``` {.python .cell-code}\nfilenames\n```\n\n::: {.cell-output .cell-output-display execution_count=30}\n```\n['data/nycflights/1990.csv',\n 'data/nycflights/1991.csv',\n 'data/nycflights/1992.csv',\n 'data/nycflights/1993.csv',\n 'data/nycflights/1994.csv',\n 'data/nycflights/1995.csv',\n 'data/nycflights/1996.csv',\n 'data/nycflights/1997.csv',\n 'data/nycflights/1998.csv',\n 'data/nycflights/1999.csv']\n```\n:::\n:::\n\n\n::: {#22905793 .cell execution_count=31}\n``` {.python .cell-code}\n%%time\n\nsums = []\ncounts = []\nfor fn in filenames:\n    # Read in file\n    df = pd.read_csv(fn)\n\n    # Groupby origin airport\n    by_origin = df.groupby(\"Origin\")\n\n    # Sum of all departure delays by origin\n    total = by_origin.DepDelay.sum()\n\n    # Number of flights by origin\n    count = by_origin.DepDelay.count()\n\n    # Save the intermediates\n    sums.append(total)\n    counts.append(count)\n\n# Combine intermediates to get total mean-delay-per-origin\ntotal_delays = sum(sums)\nn_flights = sum(counts)\nmean = total_delays / n_flights\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCPU times: user 3.47 s, sys: 152 ms, total: 3.62 s\nWall time: 3.83 s\n```\n:::\n:::\n\n\n::: {#cea2edcc .cell execution_count=32}\n``` {.python .cell-code}\nmean\n```\n\n::: {.cell-output .cell-output-display execution_count=32}\n```\nOrigin\nEWR    10.295469\nJFK    10.351299\nLGA     7.431142\nName: DepDelay, dtype: float64\n```\n:::\n:::\n\n\n### Parallelize the code above\n\nUse `dask.delayed` to parallelize the code above.  Some extra things you will need to know.\n\n1.  Methods and attribute access on delayed objects work automatically, so if you have a delayed object you can perform normal arithmetic, slicing, and method calls on it and it will produce the correct delayed calls.\n    \n2.  Calling the `.compute()` method works well when you have a single output.  When you have multiple outputs you might want to use the `dask.compute` function. This way Dask can share the intermediate values.\n    \nSo your goal is to parallelize the code above (which has been copied below) using `dask.delayed`.  You may also want to visualize a bit of the computation to see if you're doing it correctly.\n\n```python\n%%time\n# your code here\n```\n\n::: {#da7af1c8 .cell tags='[\"solution\"]' execution_count=33}\n``` {.python .cell-code}\n%%time\n\n# This is just one possible solution, there are\n# several ways to do this using `dask.delayed`\n\n\n@dask.delayed\ndef read_file(filename):\n    # Read in file\n    return pd.read_csv(filename)\n\n\nsums = []\ncounts = []\nfor fn in filenames:\n    # Delayed read in file\n    df = read_file(fn)\n\n    # Groupby origin airport\n    by_origin = df.groupby(\"Origin\")\n\n    # Sum of all departure delays by origin\n    total = by_origin.DepDelay.sum()\n\n    # Number of flights by origin\n    count = by_origin.DepDelay.count()\n\n    # Save the intermediates\n    sums.append(total)\n    counts.append(count)\n\n# Combine intermediates to get total mean-delay-per-origin\ntotal_delays = sum(sums)\nn_flights = sum(counts)\nmean, *_ = dask.compute(total_delays / n_flights)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCPU times: user 8.92 ms, sys: 5.11 ms, total: 14 ms\nWall time: 1.06 s\n```\n:::\n:::\n\n\n::: {#a4af1c46 .cell execution_count=34}\n``` {.python .cell-code}\n# ensure the results still match\nmean\n```\n\n::: {.cell-output .cell-output-display execution_count=34}\n```\nOrigin\nEWR    10.295469\nJFK    10.351299\nLGA     7.431142\nName: DepDelay, dtype: float64\n```\n:::\n:::\n\n\n### Some questions to consider:\n\n- How much speedup did you get? Is this how much speedup you'd expect?\n- Experiment with where to call `compute`. What happens when you call it on `sums` and `counts`? What happens if you wait and call it on `mean`?\n- Experiment with delaying the call to `sum`. What does the graph look like if `sum` is delayed? What does the graph look like if it isn't?\n- Can you think of any reason why you'd want to do the reduction one way over the other?\n\n### Learn More\n\nVisit the [Delayed documentation](https://docs.dask.org/en/latest/delayed.html). In particular, this [delayed screencast](https://www.youtube.com/watch?v=SHqFmynRxVU) will reinforce the concepts you learned here and the [delayed best practices](https://docs.dask.org/en/latest/delayed-best-practices.html) document collects advice on using `dask.delayed` well.\n\nSome improvements by actual parallelization of file reading, but we’re limited by IO throughput.\n\n::: {#2932b6e6 .cell tags='[\"solution\"]' execution_count=35}\n``` {.python .cell-code}\ndask.compute(sums)\n```\n\n::: {.cell-output .cell-output-display execution_count=35}\n```\n([Origin\n  EWR    1062573.0\n  JFK     554956.0\n  LGA     898351.0\n  Name: DepDelay, dtype: float64,\n  Origin\n  EWR    776235.0\n  JFK    389520.0\n  LGA    577681.0\n  Name: DepDelay, dtype: float64,\n  Origin\n  EWR    976045.0\n  JFK    422302.0\n  LGA    659255.0\n  Name: DepDelay, dtype: float64,\n  Origin\n  EWR    1119295.0\n  JFK     351783.0\n  LGA     617911.0\n  Name: DepDelay, dtype: float64,\n  Origin\n  EWR    1322649.0\n  JFK     448715.0\n  LGA     765889.0\n  Name: DepDelay, dtype: float64,\n  Origin\n  EWR    948014.0\n  JFK    457644.0\n  LGA    686691.0\n  Name: DepDelay, dtype: float64,\n  Origin\n  EWR    1548420.0\n  JFK     680821.0\n  LGA     799150.0\n  Name: DepDelay, dtype: float64,\n  Origin\n  EWR    1250156.0\n  JFK     366344.0\n  LGA     562100.0\n  Name: DepDelay, dtype: float64,\n  Origin\n  EWR    1295784.0\n  JFK     358156.0\n  LGA     701016.0\n  Name: DepDelay, dtype: float64,\n  Origin\n  EWR    1432011.0\n  JFK     392279.0\n  LGA     971872.0\n  Name: DepDelay, dtype: float64],)\n```\n:::\n:::\n\n\n::: {#ef225aa2 .cell tags='[\"solution\"]' execution_count=36}\n``` {.python .cell-code}\ndask.compute(counts)\n```\n\n::: {.cell-output .cell-output-display execution_count=36}\n```\n([Origin\n  EWR    115895\n  JFK     46803\n  LGA    104947\n  Name: DepDelay, dtype: int64,\n  Origin\n  EWR    112234\n  JFK     41832\n  LGA    100882\n  Name: DepDelay, dtype: int64,\n  Origin\n  EWR    113801\n  JFK     42030\n  LGA    101553\n  Name: DepDelay, dtype: int64,\n  Origin\n  EWR    110286\n  JFK     41280\n  LGA    101122\n  Name: DepDelay, dtype: int64,\n  Origin\n  EWR    112516\n  JFK     42243\n  LGA     98571\n  Name: DepDelay, dtype: int64,\n  Origin\n  EWR    106398\n  JFK     45412\n  LGA     96810\n  Name: DepDelay, dtype: int64,\n  Origin\n  EWR    114019\n  JFK     42688\n  LGA     92367\n  Name: DepDelay, dtype: int64,\n  Origin\n  EWR    118228\n  JFK     39246\n  LGA     94042\n  Name: DepDelay, dtype: int64,\n  Origin\n  EWR    116028\n  JFK     41865\n  LGA     91025\n  Name: DepDelay, dtype: int64,\n  Origin\n  EWR    120046\n  JFK     43844\n  LGA     92948\n  Name: DepDelay, dtype: int64],)\n```\n:::\n:::\n\n\n::: {#a05d2870 .cell tags='[\"solution\"]' execution_count=37}\n``` {.python .cell-code}\n%%time\n\n# This is just one possible solution, there are\n# several ways to do this using `dask.delayed`\n\n\n@dask.delayed\ndef read_file(filename):\n    # Read in file\n    return pd.read_csv(filename)\n\n\nsums = []\ncounts = []\nfor fn in filenames:\n    # Delayed read in file\n    df = read_file(fn)\n\n    # Groupby origin airport\n    by_origin = df.groupby(\"Origin\")\n\n    # Sum of all departure delays by origin\n    total = by_origin.DepDelay.sum()\n\n    # Number of flights by origin\n    count = by_origin.DepDelay.count()\n\n    # Save the intermediates\n    sums.append(total)\n    counts.append(count)\n\n# Combine intermediates to get total mean-delay-per-origin\ntotal_delays = dask.delayed(sum)(sums)\nn_flights = dask.delayed(sum)(counts)\nmean, *_ = dask.compute(total_delays / n_flights)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCPU times: user 9.65 ms, sys: 0 ns, total: 9.65 ms\nWall time: 917 ms\n```\n:::\n:::\n\n\n::: {#de0fad5b .cell tags='[\"solution\"]' execution_count=38}\n``` {.python .cell-code}\ndask.delayed(sum)(sums).visualize()\n```\n\n::: {.cell-output .cell-output-display execution_count=38}\n![](5_1_Dask_delayed_files/figure-ipynb/cell-39-output-1.png){}\n:::\n:::\n\n\n::: {#226ea5ad .cell tags='[\"solution\"]' execution_count=39}\n``` {.python .cell-code}\nsum(sums).visualize()\n```\n\n::: {.cell-output .cell-output-display execution_count=39}\n![](5_1_Dask_delayed_files/figure-ipynb/cell-40-output-1.png){}\n:::\n:::\n\n\n:::solution\nDelaying the sum could be interesting in case to make more balanced loads between tasks.\n:::\n\n## Close the Client\n\nBefore moving on to the next exercise, make sure to close your client or stop this kernel.\n\n::: {#62b6a5a5 .cell execution_count=40}\n``` {.python .cell-code}\nclient.close()\n```\n:::\n\n\n---\njupyter:\n  kernelspec:\n    display_name: Python 3 (ipykernel)\n    language: python\n    name: python3\n    path: /opt/conda/share/jupyter/kernels/python3\n  language_info:\n    codemirror_mode:\n      name: ipython\n      version: 3\n    file_extension: .py\n    mimetype: text/x-python\n    name: python\n    nbconvert_exporter: python\n    pygments_lexer: ipython3\n    version: 3.12.5\n---\n",
    "supporting": [
      "5_1_Dask_delayed_files/figure-ipynb"
    ],
    "filters": []
  }
}