<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="François-David Collin">
<meta name="author" content="Ghislain Durif">

<title>Dask delayed App</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="5_1_Dask_delayed_files/libs/clipboard/clipboard.min.js"></script>
<script src="5_1_Dask_delayed_files/libs/quarto-html/quarto.js"></script>
<script src="5_1_Dask_delayed_files/libs/quarto-html/popper.min.js"></script>
<script src="5_1_Dask_delayed_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="5_1_Dask_delayed_files/libs/quarto-html/anchor.min.js"></script>
<link href="5_1_Dask_delayed_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="5_1_Dask_delayed_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="5_1_Dask_delayed_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="5_1_Dask_delayed_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="5_1_Dask_delayed_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="5_1_Dask_delayed_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="5_1_Dask_delayed_files/libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="5_1_Dask_delayed.ipynb" download="5_1_Dask_delayed.ipynb"><i class="bi bi-journal-code"></i>Jupyter</a></li></ul></div></div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Dask <code>delayed</code> App</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">François-David Collin <a href="mailto:francois-david.collin@umontpellier.fr" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            CNRS
          </p>
        <p class="affiliation">
            IMAG
          </p>
        <p class="affiliation">
            Paul-Valéry Montpellier 3 University
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Ghislain Durif <a href="mailto:ghislain.durif@ens-lyon.fr" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            CNRS
          </p>
        <p class="affiliation">
            LBMC
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<p><img src="https://docs.dask.org/en/latest/_images/dask_horizontal.svg" align="right" width="30%" alt="Dask logo\"></p>
<section id="dask.delayed---parallelize-any-code" class="level1">
<h1>dask.delayed - parallelize any code</h1>
<p>What if you don’t have an array or dataframe? Instead of having blocks where the function is applied to each block, you can decorate functions with <code>@delayed</code> and <em>have the functions themselves be lazy</em>.</p>
<p>This is a simple way to use <code>dask</code> to parallelize existing codebases or build <a href="https://blog.dask.org/2018/02/09/credit-models-with-dask">complex systems</a>.</p>
<p><strong>Related Documentation</strong></p>
<ul>
<li><a href="https://docs.dask.org/en/latest/delayed.html">Delayed documentation</a></li>
<li><a href="https://www.youtube.com/watch?v=SHqFmynRxVU">Delayed screencast</a></li>
<li><a href="https://docs.dask.org/en/latest/delayed-api.html">Delayed API</a></li>
<li><a href="https://examples.dask.org/delayed.html">Delayed examples</a></li>
<li><a href="https://docs.dask.org/en/latest/delayed-best-practices.html">Delayed best practices</a></li>
</ul>
<p>As we’ll see in the <a href="05_distributed.ipynb">distributed scheduler notebook</a>, Dask has several ways of executing code in parallel. We’ll use the distributed scheduler by creating a <code>dask.distributed.Client</code>. For now, this will provide us with some nice diagnostics. We’ll talk about schedulers in depth later.</p>
<section id="iniatilization-of-the-ipyparalleldask-interface" class="level3">
<h3 class="anchored" data-anchor-id="iniatilization-of-the-ipyparalleldask-interface">Iniatilization of the ipyparallel/dask interface</h3>
<div id="134681f9" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ipyparallel <span class="im">import</span> Client</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">### Force the 8 nodes/1 core layout</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>rc <span class="op">=</span> Client()</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>rc.stop_distributed()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> rc.become_dask()</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>client</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="a-typical-workflow" class="level2">
<h2 class="anchored" data-anchor-id="a-typical-workflow">A Typical Workflow</h2>
<p>Typically if a workflow contains a for-loop it can benefit from delayed. The following example outlines a read-transform-write:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_file(filename):</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> read_a_file(filename)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> do_a_transformation(data)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    destination <span class="op">=</span> <span class="ss">f"results/</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    write_out_data(data, destination)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> destination</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> filename <span class="kw">in</span> filenames:</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    results.append(process_file(filename))</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>dask.compute(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="basics" class="level2">
<h2 class="anchored" data-anchor-id="basics">Basics</h2>
<p>First let’s make some toy functions, <code>inc</code> and <code>add</code>, that sleep for a while to simulate work. We’ll then time running these functions normally.</p>
<p>In the next section we’ll parallelize this code.</p>
<div id="10a3ea32" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inc(x):</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add(x, y):</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We time the execution of this normal code using the <code>%%time</code> magic, which is a special function of the Jupyter Notebook.</p>
<div id="cf361668" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This takes three seconds to run because we call each</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># function sequentially, one after the other</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> inc(<span class="dv">1</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> inc(<span class="dv">2</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> add(x, y) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="parallelize-with-the-dask.delayed-decorator" class="level3">
<h3 class="anchored" data-anchor-id="parallelize-with-the-dask.delayed-decorator">Parallelize with the <code>dask.delayed</code> decorator</h3>
<p>Those two increment calls <em>could</em> be called in parallel, because they are totally independent of one-another.</p>
<p>We’ll make the <code>inc</code> and <code>add</code> functions lazy using the <code>dask.delayed</code> decorator. When we call the delayed version by passing the arguments, exactly as before, the original function isn’t actually called yet - which is why the cell execution finishes very quickly. Instead, a <em>delayed object</em> is made, which keeps track of the function to call and the arguments to pass to it.</p>
<div id="fce9826a" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inc(x):</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add(x, y):</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="58d87fd7" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This runs immediately, all it does is build a graph</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> inc(<span class="dv">1</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> inc(<span class="dv">2</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> add(x, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This ran immediately, since nothing has really happened yet.</p>
<p>To get the result, call <code>compute</code>. Notice that this runs faster than the original code.</p>
<div id="5e64115c" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This actually runs our computation using a local thread pool</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>z.compute()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="what-just-happened" class="level2">
<h2 class="anchored" data-anchor-id="what-just-happened">What just happened?</h2>
<p>The <code>z</code> object is a lazy <code>Delayed</code> object. This object holds everything we need to compute the final result, including references to all of the functions that are required and their inputs and relationship to one-another. We can evaluate the result with <code>.compute()</code> as above or we can visualize the task graph for this value with <code>.visualize()</code>.</p>
<div id="491a3670" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>z</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="d7d7dd7a" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the task graph for `z`</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>z.visualize()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Notice that this includes the names of the functions from before, and the logical flow of the outputs of the <code>inc</code> functions to the inputs of <code>add</code>.</p>
<section id="some-questions-to-consider" class="level3">
<h3 class="anchored" data-anchor-id="some-questions-to-consider">Some questions to consider:</h3>
<ul>
<li>Why did we go from 3s to 2s? Why weren’t we able to parallelize down to 1s?</li>
<li>What would have happened if the inc and add functions didn’t include the <code>sleep(1)</code>? Would Dask still be able to speed up this code?</li>
<li>What if we have multiple outputs or also want to get access to x or y?</li>
</ul>
</section>
</section>
<section id="exercise-parallelize-a-for-loop" class="level2">
<h2 class="anchored" data-anchor-id="exercise-parallelize-a-for-loop">Exercise: Parallelize a for loop</h2>
<p><code>for</code> loops are one of the most common things that we want to parallelize. Use <code>dask.delayed</code> on <code>inc</code> and <code>sum</code> to parallelize the computation below:</p>
<div id="655aa457" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="e7f60f1b" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Sequential code</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inc(x):</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> data:</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> inc(x)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    results.append(y)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> <span class="bu">sum</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="35bf521c" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>total</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="7ba0b710" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Your parallel code here...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>How do the graph visualizations compare with the given solution, compared to a version with the <code>sum</code> function used directly rather than wrapped with <code>delayed</code>? Can you explain the latter version? You might find the result of the following expression illuminating</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>inc(<span class="dv">1</span>) <span class="op">+</span> inc(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="putting-it-all-together-with-a-the-producer-consumer-pattern" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-all-together-with-a-the-producer-consumer-pattern">Putting it all together with a the producer-consumer pattern</h2>
</section>
<section id="introduction-with-a-simple-producer-consumer-example" class="level2">
<h2 class="anchored" data-anchor-id="introduction-with-a-simple-producer-consumer-example">Introduction with a simple producer-consumer example</h2>
<p>We’ll try to reproduce the producer/consumer code from asynchronous application with <code>asyncio</code> or <code>threading</code> but with <code>dask.delayed</code> and compute</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dask <span class="im">import</span> delayed, compute</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Queue, <span class="bu">print</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>queue <span class="op">=</span> Queue()</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exercise-parallelize-a-for-loop-code-with-control-flow" class="level2">
<h2 class="anchored" data-anchor-id="exercise-parallelize-a-for-loop-code-with-control-flow">Exercise: Parallelize a for-loop code with control flow</h2>
<p>Often we want to delay only <em>some</em> functions, running a few of them immediately. This is especially helpful when those functions are fast and help us to determine what other slower functions we should call. This decision, to delay or not to delay, is usually where we need to be thoughtful when using <code>dask.delayed</code>.</p>
<p>In the example below we iterate through a list of inputs. If that input is even then we want to call <code>inc</code>. If the input is odd then we want to call <code>double</code>. This <code>is_even</code> decision to call <code>inc</code> or <code>double</code> has to be made immediately (not lazily) in order for our graph-building Python code to proceed.</p>
<div id="e45b6e21" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> double(x):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> x</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inc(x):</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_even(x):</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">not</span> x <span class="op">%</span> <span class="dv">2</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="aa64f9cc" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Sequential code</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> data:</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_even(x):</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> double(x)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> inc(x)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    results.append(y)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> <span class="bu">sum</span>(results)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(total)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Your parallel code here...</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: parallelize the sequential code above using dask.delayed</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># You will need to delay some functions, but not all</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="some-questions-to-consider-1" class="level3">
<h3 class="anchored" data-anchor-id="some-questions-to-consider-1">Some questions to consider:</h3>
<ul>
<li><p>What are other examples of control flow where we can’t use delayed?</p></li>
<li><p>What would have happened if we had delayed the evaluation of <code>is_even(x)</code> in the example above?</p></li>
<li><p>What are your thoughts on delaying <code>sum</code>? This function is both computational but also fast to run.</p></li>
<li><p>Example of control flow with we can’t use delayed&nbsp;: conditional loops, recursive functions</p></li>
<li><p>Nothing, we have to compute it immediately for branching</p></li>
<li><p>Delaying sum isn’t worth the graph walk overload</p></li>
</ul>
</section>
</section>
<section id="exercise-parallelize-a-pandas-groupby-reduction" class="level2">
<h2 class="anchored" data-anchor-id="exercise-parallelize-a-pandas-groupby-reduction">Exercise: Parallelize a Pandas Groupby Reduction</h2>
<p>In this exercise we read several CSV files and perform a groupby operation in parallel. We are given sequential code to do this and parallelize it with <code>dask.delayed</code>.</p>
<p>The computation we will parallelize is to compute the mean departure delay per airport from some historical flight data. We will do this by using <code>dask.delayed</code> together with <code>pandas</code>. In a future section we will do this same exercise with <code>dask.dataframe</code>.</p>
</section>
<section id="create-data" class="level2">
<h2 class="anchored" data-anchor-id="create-data">Create data</h2>
<p>Run this code to prep some data.</p>
<p>This downloads and extracts some historical flight data for flights out of NYC between 1990 and 2000. The data is originally from <a href="http://stat-computing.org/dataexpo/2009/the-data.html">here</a>.</p>
<div id="6f847eae" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">"data"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>code_url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/dask/dask-tutorial/main/prep.py"</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"prep.py"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    f.write(requests.get(code_url).content)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>run prep.py <span class="op">-</span>d flights</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="inspect-data" class="level3">
<h3 class="anchored" data-anchor-id="inspect-data">Inspect data</h3>
<div id="4848fd2f" class="cell" data-execution_count="24">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sorted</span>(os.listdir(os.path.join(<span class="st">"data"</span>, <span class="st">"nycflights"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="read-one-file-with-pandas.read_csv-and-compute-mean-departure-delay" class="level3">
<h3 class="anchored" data-anchor-id="read-one-file-with-pandas.read_csv-and-compute-mean-departure-delay">Read one file with <code>pandas.read_csv</code> and compute mean departure delay</h3>
<div id="284cfe15" class="cell" data-execution_count="25">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(os.path.join(<span class="st">"data"</span>, <span class="st">"nycflights"</span>, <span class="st">"1990.csv"</span>))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="e68858f3" class="cell" data-execution_count="26">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What is the schema?</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>df.dtypes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="f25b86a0" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What originating airports are in the data?</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>df.Origin.unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="13f7a654" class="cell" data-execution_count="28">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean departure delay per-airport for one year</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>df.groupby(<span class="st">"Origin"</span>).DepDelay.mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="sequential-code-mean-departure-delay-per-airport" class="level3">
<h3 class="anchored" data-anchor-id="sequential-code-mean-departure-delay-per-airport">Sequential code: Mean Departure Delay Per Airport</h3>
<p>The above cell computes the mean departure delay per-airport for one year. Here we expand that to all years using a sequential for loop.</p>
<div id="9bf4f09c" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>filenames <span class="op">=</span> <span class="bu">sorted</span>(glob(os.path.join(<span class="st">"data"</span>, <span class="st">"nycflights"</span>, <span class="st">"*.csv"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="ecc55721" class="cell" data-execution_count="30">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>filenames</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="7026bd78" class="cell" data-execution_count="31">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>sums <span class="op">=</span> []</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> []</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fn <span class="kw">in</span> filenames:</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read in file</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(fn)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Groupby origin airport</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    by_origin <span class="op">=</span> df.groupby(<span class="st">"Origin"</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sum of all departure delays by origin</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> by_origin.DepDelay.<span class="bu">sum</span>()</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of flights by origin</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> by_origin.DepDelay.count()</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the intermediates</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    sums.append(total)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    counts.append(count)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine intermediates to get total mean-delay-per-origin</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>total_delays <span class="op">=</span> <span class="bu">sum</span>(sums)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>n_flights <span class="op">=</span> <span class="bu">sum</span>(counts)</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>mean <span class="op">=</span> total_delays <span class="op">/</span> n_flights</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="e0448ce0" class="cell" data-execution_count="32">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="parallelize-the-code-above" class="level3">
<h3 class="anchored" data-anchor-id="parallelize-the-code-above">Parallelize the code above</h3>
<p>Use <code>dask.delayed</code> to parallelize the code above. Some extra things you will need to know.</p>
<ol type="1">
<li><p>Methods and attribute access on delayed objects work automatically, so if you have a delayed object you can perform normal arithmetic, slicing, and method calls on it and it will produce the correct delayed calls.</p></li>
<li><p>Calling the <code>.compute()</code> method works well when you have a single output. When you have multiple outputs you might want to use the <code>dask.compute</code> function. This way Dask can share the intermediate values.</p></li>
</ol>
<p>So your goal is to parallelize the code above (which has been copied below) using <code>dask.delayed</code>. You may also want to visualize a bit of the computation to see if you’re doing it correctly.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># your code here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="cd3e55fc" class="cell" data-execution_count="34">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ensure the results still match</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="some-questions-to-consider-2" class="level3">
<h3 class="anchored" data-anchor-id="some-questions-to-consider-2">Some questions to consider:</h3>
<ul>
<li>How much speedup did you get? Is this how much speedup you’d expect?</li>
<li>Experiment with where to call <code>compute</code>. What happens when you call it on <code>sums</code> and <code>counts</code>? What happens if you wait and call it on <code>mean</code>?</li>
<li>Experiment with delaying the call to <code>sum</code>. What does the graph look like if <code>sum</code> is delayed? What does the graph look like if it isn’t?</li>
<li>Can you think of any reason why you’d want to do the reduction one way over the other?</li>
</ul>
</section>
<section id="learn-more" class="level3">
<h3 class="anchored" data-anchor-id="learn-more">Learn More</h3>
<p>Visit the <a href="https://docs.dask.org/en/latest/delayed.html">Delayed documentation</a>. In particular, this <a href="https://www.youtube.com/watch?v=SHqFmynRxVU">delayed screencast</a> will reinforce the concepts you learned here and the <a href="https://docs.dask.org/en/latest/delayed-best-practices.html">delayed best practices</a> document collects advice on using <code>dask.delayed</code> well.</p>
<p>Some improvements by actual parallelization of file reading, but we’re limited by IO throughput.</p>
<div class="proof solution">
<p><span class="proof-title"><em>Solution</em>. </span>Delaying the sum could be interesting in case to make more balanced loads between tasks.</p>
</div>
</section>
</section>
<section id="close-the-client" class="level2">
<h2 class="anchored" data-anchor-id="close-the-client">Close the Client</h2>
<p>Before moving on to the next exercise, make sure to close your client or stop this kernel.</p>
<div id="90405d24" class="cell" data-execution_count="40">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>client.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- -->

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Dask `delayed` App"</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: false</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>&lt;img src="https://docs.dask.org/en/latest/_images/dask_horizontal.svg"</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>     align="right"</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>     width="30%"</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>     alt="Dask logo\"&gt;</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="fu"># dask.delayed - parallelize any code</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>What if you don't have an array or dataframe? Instead of having blocks where the function is applied to each block, you can decorate functions with <span class="in">`@delayed`</span> and _have the functions themselves be lazy_. </span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>This is a simple way to use <span class="in">`dask`</span> to parallelize existing codebases or build <span class="co">[</span><span class="ot">complex systems</span><span class="co">](https://blog.dask.org/2018/02/09/credit-models-with-dask)</span>. </span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>**Related Documentation**</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Delayed documentation</span><span class="co">](https://docs.dask.org/en/latest/delayed.html)</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Delayed screencast</span><span class="co">](https://www.youtube.com/watch?v=SHqFmynRxVU)</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Delayed API</span><span class="co">](https://docs.dask.org/en/latest/delayed-api.html)</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Delayed examples</span><span class="co">](https://examples.dask.org/delayed.html)</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="co">[</span><span class="ot">Delayed best practices</span><span class="co">](https://docs.dask.org/en/latest/delayed-best-practices.html)</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>As we'll see in the <span class="co">[</span><span class="ot">distributed scheduler notebook</span><span class="co">](05_distributed.ipynb)</span>, Dask has several ways of executing code in parallel. We'll use the distributed scheduler by creating a <span class="in">`dask.distributed.Client`</span>. For now, this will provide us with some nice diagnostics. We'll talk about schedulers in depth later.</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="fu">### Iniatilization of the ipyparallel/dask interface</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ipyparallel <span class="im">import</span> Client</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="co">### Force the 8 nodes/1 core layout</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>rc <span class="op">=</span> Client()</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>rc.stop_distributed()</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> rc.become_dask()</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>client</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a><span class="fu">## A Typical Workflow</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>Typically if a workflow contains a for-loop it can benefit from delayed. The following example outlines a read-transform-write:</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_file(filename):</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> read_a_file(filename)</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> do_a_transformation(data)</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>    destination <span class="op">=</span> <span class="ss">f"results/</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>    write_out_data(data, destination)</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> destination</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> filename <span class="kw">in</span> filenames:</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>    results.append(process_file(filename))</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>dask.compute(results)</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a><span class="fu">## Basics</span></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>First let's make some toy functions, <span class="in">`inc`</span> and <span class="in">`add`</span>, that sleep for a while to simulate work. We'll then time running these functions normally.</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>In the next section we'll parallelize this code.</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inc(x):</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add(x, y):</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> y</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>We time the execution of this normal code using the <span class="in">`%%time`</span> magic, which is a special function of the Jupyter Notebook.</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a><span class="co"># This takes three seconds to run because we call each</span></span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a><span class="co"># function sequentially, one after the other</span></span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> inc(<span class="dv">1</span>)</span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> inc(<span class="dv">2</span>)</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> add(x, y) </span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a><span class="fu">### Parallelize with the `dask.delayed` decorator</span></span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>Those two increment calls *could* be called in parallel, because they are totally independent of one-another.</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a>We'll make the <span class="in">`inc`</span> and <span class="in">`add`</span> functions lazy using the <span class="in">`dask.delayed`</span> decorator. When we call the delayed version by passing the arguments, exactly as before, the original function isn't actually called yet - which is why the cell execution finishes very quickly.</span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>Instead, a *delayed object* is made, which keeps track of the function to call and the arguments to pass to it.</span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inc(x):</span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add(x, y):</span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> y</span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a><span class="co"># This runs immediately, all it does is build a graph</span></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> inc(<span class="dv">1</span>)</span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> inc(<span class="dv">2</span>)</span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> add(x, y)</span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>This ran immediately, since nothing has really happened yet.</span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a>To get the result, call <span class="in">`compute`</span>. Notice that this runs faster than the original code.</span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a><span class="co"># This actually runs our computation using a local thread pool</span></span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>z.compute()</span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a><span class="fu">## What just happened?</span></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a>The <span class="in">`z`</span> object is a lazy <span class="in">`Delayed`</span> object.  This object holds everything we need to compute the final result, including references to all of the functions that are required and their inputs and relationship to one-another.  We can evaluate the result with <span class="in">`.compute()`</span> as above or we can visualize the task graph for this value with <span class="in">`.visualize()`</span>.</span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>z</span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the task graph for `z`</span></span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a>z.visualize()</span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>Notice that this includes the names of the functions from before, and the logical flow of the outputs of the <span class="in">`inc`</span> functions to the inputs of <span class="in">`add`</span>.</span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a><span class="fu">### Some questions to consider:</span></span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span>Why did we go from 3s to 2s?  Why weren't we able to parallelize down to 1s?</span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span>What would have happened if the inc and add functions didn't include the <span class="in">`sleep(1)`</span>?  Would Dask still be able to speed up this code?</span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span>What if we have multiple outputs or also want to get access to x or y?</span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise: Parallelize a for loop</span></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a><span class="in">`for`</span> loops are one of the most common things that we want to parallelize.  Use <span class="in">`dask.delayed`</span> on <span class="in">`inc`</span> and <span class="in">`sum`</span> to parallelize the computation below:</span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>] </span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Sequential code</span></span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inc(x):</span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> data:</span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> inc(x)</span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a>    results.append(y)</span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> <span class="bu">sum</span>(results)</span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a>total</span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Your parallel code here...</span></span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inc(x):</span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> data:</span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> inc(x)</span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>    results.append(y)</span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> dask.delayed(<span class="bu">sum</span>)(results)</span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Before computing:"</span>, total)  <span class="co"># Let's see what type of thing total is</span></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> total.compute()</span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"After computing :"</span>, result)  <span class="co"># After it's computed</span></span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a>How do the graph visualizations compare with the given solution, compared to a version with the <span class="in">`sum`</span> function used directly rather than wrapped with <span class="in">`delayed`</span>? Can you explain the latter version? You might find the result of the following expression illuminating</span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a>inc(<span class="dv">1</span>) <span class="op">+</span> inc(<span class="dv">2</span>)</span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a>(inc(<span class="dv">1</span>) <span class="op">+</span> inc(<span class="dv">2</span>)).visualize()</span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a><span class="bu">sum</span>([inc(<span class="dv">1</span>),inc(<span class="dv">2</span>),inc(<span class="dv">3</span>)]).visualize()</span>
<span id="cb32-257"><a href="#cb32-257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a>total.visualize()</span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a><span class="fu">## Putting it all together with a the producer-consumer pattern</span></span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction with a simple producer-consumer example</span></span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a>We’ll try to reproduce the producer/consumer code from asynchronous application with <span class="in">`asyncio`</span> or <span class="in">`threading`</span> but with <span class="in">`dask.delayed`</span> and compute</span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dask <span class="im">import</span> delayed, compute</span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Queue, <span class="bu">print</span></span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a>queue <span class="op">=</span> Queue()</span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dask <span class="im">import</span> delayed, compute</span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Queue, <span class="bu">print</span></span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a>queue <span class="op">=</span> Queue()</span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a><span class="at">@delayed</span></span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> produce(queue, n):</span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"producing </span><span class="sc">{}</span><span class="st"> items"</span>.<span class="bu">format</span>(n))</span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a>        <span class="co"># simulate i/o operation using sleep</span></span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a>        sleep(<span class="dv">1</span>)</span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a>        <span class="co"># produce an item</span></span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"producing </span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(x, n))</span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a>        item <span class="op">=</span> <span class="bu">str</span>(x)</span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a>        <span class="co"># put the item in the queue</span></span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a>        queue.put(item)</span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a>    <span class="co"># indicate the producer is done</span></span>
<span id="cb32-304"><a href="#cb32-304" aria-hidden="true" tabindex="-1"></a>    queue.put(<span class="va">None</span>)</span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n</span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a><span class="at">@delayed</span></span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> consume(queue):</span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a>    consumed <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"consuming items"</span>)</span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a>        <span class="co"># wait for an item from the producer</span></span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a>        item <span class="op">=</span> queue.get()</span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> item <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a>            <span class="co"># the producer emits None to indicate that it is done</span></span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a>        <span class="co"># process the item</span></span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"consuming </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(item))</span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a>        consumed <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> consumed</span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a>compute(</span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a>    produce(queue, <span class="dv">5</span>), </span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a>    consume(queue)</span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise: Parallelize a for-loop code with control flow</span></span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a>Often we want to delay only *some* functions, running a few of them immediately.  This is especially helpful when those functions are fast and help us to determine what other slower functions we should call.  This decision, to delay or not to delay, is usually where we need to be thoughtful when using <span class="in">`dask.delayed`</span>.</span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a>In the example below we iterate through a list of inputs.  If that input is even then we want to call <span class="in">`inc`</span>.  If the input is odd then we want to call <span class="in">`double`</span>.  This <span class="in">`is_even`</span> decision to call <span class="in">`inc`</span> or <span class="in">`double`</span> has to be made immediately (not lazily) in order for our graph-building Python code to proceed.</span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-337"><a href="#cb32-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> double(x):</span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> x</span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inc(x):</span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_even(x):</span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">not</span> x <span class="op">%</span> <span class="dv">2</span></span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]</span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a><span class="co"># Sequential code</span></span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb32-360"><a href="#cb32-360" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> data:</span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_even(x):</span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> double(x)</span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-364"><a href="#cb32-364" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> inc(x)</span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a>    results.append(y)</span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> <span class="bu">sum</span>(results)</span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(total)</span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a><span class="co"># Your parallel code here...</span></span>
<span id="cb32-374"><a href="#cb32-374" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: parallelize the sequential code above using dask.delayed</span></span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a><span class="co"># You will need to delay some functions, but not all</span></span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-380"><a href="#cb32-380" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> double(x):</span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> x</span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inc(x):</span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="cb32-393"><a href="#cb32-393" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> data:</span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_even(x):  <span class="co"># even</span></span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> double(x)</span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># odd</span></span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> inc(x)</span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a>    results.append(y)</span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> <span class="bu">sum</span>(results)</span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time total.compute()</span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-414"><a href="#cb32-414" aria-hidden="true" tabindex="-1"></a>total.visualize()</span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a><span class="fu">### Some questions to consider:</span></span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span>What are other examples of control flow where we can't use delayed?</span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span>What would have happened if we had delayed the evaluation of <span class="in">`is_even(x)`</span> in the example above?</span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span>What are your thoughts on delaying <span class="in">`sum`</span>?  This function is both computational but also fast to run.</span>
<span id="cb32-422"><a href="#cb32-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-423"><a href="#cb32-423" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Example of control flow with we can’t use delayed&nbsp;: conditional loops, recursive functions</span>
<span id="cb32-424"><a href="#cb32-424" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Nothing, we have to compute it immediately for branching</span>
<span id="cb32-425"><a href="#cb32-425" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Delaying sum isn’t worth the graph walk overload</span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-427"><a href="#cb32-427" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise: Parallelize a Pandas Groupby Reduction</span></span>
<span id="cb32-428"><a href="#cb32-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-429"><a href="#cb32-429" aria-hidden="true" tabindex="-1"></a>In this exercise we read several CSV files and perform a groupby operation in parallel.  We are given sequential code to do this and parallelize it with <span class="in">`dask.delayed`</span>.</span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a>The computation we will parallelize is to compute the mean departure delay per airport from some historical flight data.  We will do this by using <span class="in">`dask.delayed`</span> together with <span class="in">`pandas`</span>.  In a future section we will do this same exercise with <span class="in">`dask.dataframe`</span>.</span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create data</span></span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a>Run this code to prep some data.</span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a>This downloads and extracts some historical flight data for flights out of NYC between 1990 and 2000. The data is originally from <span class="co">[</span><span class="ot">here</span><span class="co">](http://stat-computing.org/dataexpo/2009/the-data.html)</span>.</span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-442"><a href="#cb32-442" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb32-443"><a href="#cb32-443" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">"data"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a>code_url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/dask/dask-tutorial/main/prep.py"</span></span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"prep.py"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb32-448"><a href="#cb32-448" aria-hidden="true" tabindex="-1"></a>    f.write(requests.get(code_url).content)</span>
<span id="cb32-449"><a href="#cb32-449" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>run prep.py <span class="op">-</span>d flights</span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-451"><a href="#cb32-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-452"><a href="#cb32-452" aria-hidden="true" tabindex="-1"></a><span class="fu">### Inspect data</span></span>
<span id="cb32-453"><a href="#cb32-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-456"><a href="#cb32-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-457"><a href="#cb32-457" aria-hidden="true" tabindex="-1"></a><span class="bu">sorted</span>(os.listdir(os.path.join(<span class="st">"data"</span>, <span class="st">"nycflights"</span>)))</span>
<span id="cb32-458"><a href="#cb32-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-459"><a href="#cb32-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-460"><a href="#cb32-460" aria-hidden="true" tabindex="-1"></a><span class="fu">### Read one file with `pandas.read_csv` and compute mean departure delay</span></span>
<span id="cb32-461"><a href="#cb32-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-464"><a href="#cb32-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-465"><a href="#cb32-465" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb32-466"><a href="#cb32-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-467"><a href="#cb32-467" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(os.path.join(<span class="st">"data"</span>, <span class="st">"nycflights"</span>, <span class="st">"1990.csv"</span>))</span>
<span id="cb32-468"><a href="#cb32-468" aria-hidden="true" tabindex="-1"></a>df.head()</span>
<span id="cb32-469"><a href="#cb32-469" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-470"><a href="#cb32-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-473"><a href="#cb32-473" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-474"><a href="#cb32-474" aria-hidden="true" tabindex="-1"></a><span class="co"># What is the schema?</span></span>
<span id="cb32-475"><a href="#cb32-475" aria-hidden="true" tabindex="-1"></a>df.dtypes</span>
<span id="cb32-476"><a href="#cb32-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-477"><a href="#cb32-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-480"><a href="#cb32-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-481"><a href="#cb32-481" aria-hidden="true" tabindex="-1"></a><span class="co"># What originating airports are in the data?</span></span>
<span id="cb32-482"><a href="#cb32-482" aria-hidden="true" tabindex="-1"></a>df.Origin.unique()</span>
<span id="cb32-483"><a href="#cb32-483" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-484"><a href="#cb32-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-487"><a href="#cb32-487" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-488"><a href="#cb32-488" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean departure delay per-airport for one year</span></span>
<span id="cb32-489"><a href="#cb32-489" aria-hidden="true" tabindex="-1"></a>df.groupby(<span class="st">"Origin"</span>).DepDelay.mean()</span>
<span id="cb32-490"><a href="#cb32-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-491"><a href="#cb32-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-492"><a href="#cb32-492" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sequential code: Mean Departure Delay Per Airport</span></span>
<span id="cb32-493"><a href="#cb32-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-494"><a href="#cb32-494" aria-hidden="true" tabindex="-1"></a>The above cell computes the mean departure delay per-airport for one year. Here we expand that to all years using a sequential for loop.</span>
<span id="cb32-495"><a href="#cb32-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-498"><a href="#cb32-498" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-499"><a href="#cb32-499" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb32-500"><a href="#cb32-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-501"><a href="#cb32-501" aria-hidden="true" tabindex="-1"></a>filenames <span class="op">=</span> <span class="bu">sorted</span>(glob(os.path.join(<span class="st">"data"</span>, <span class="st">"nycflights"</span>, <span class="st">"*.csv"</span>)))</span>
<span id="cb32-502"><a href="#cb32-502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-503"><a href="#cb32-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-506"><a href="#cb32-506" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-507"><a href="#cb32-507" aria-hidden="true" tabindex="-1"></a>filenames</span>
<span id="cb32-508"><a href="#cb32-508" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-509"><a href="#cb32-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-512"><a href="#cb32-512" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-513"><a href="#cb32-513" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-514"><a href="#cb32-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-515"><a href="#cb32-515" aria-hidden="true" tabindex="-1"></a>sums <span class="op">=</span> []</span>
<span id="cb32-516"><a href="#cb32-516" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> []</span>
<span id="cb32-517"><a href="#cb32-517" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fn <span class="kw">in</span> filenames:</span>
<span id="cb32-518"><a href="#cb32-518" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read in file</span></span>
<span id="cb32-519"><a href="#cb32-519" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(fn)</span>
<span id="cb32-520"><a href="#cb32-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-521"><a href="#cb32-521" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Groupby origin airport</span></span>
<span id="cb32-522"><a href="#cb32-522" aria-hidden="true" tabindex="-1"></a>    by_origin <span class="op">=</span> df.groupby(<span class="st">"Origin"</span>)</span>
<span id="cb32-523"><a href="#cb32-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-524"><a href="#cb32-524" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sum of all departure delays by origin</span></span>
<span id="cb32-525"><a href="#cb32-525" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> by_origin.DepDelay.<span class="bu">sum</span>()</span>
<span id="cb32-526"><a href="#cb32-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-527"><a href="#cb32-527" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of flights by origin</span></span>
<span id="cb32-528"><a href="#cb32-528" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> by_origin.DepDelay.count()</span>
<span id="cb32-529"><a href="#cb32-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-530"><a href="#cb32-530" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the intermediates</span></span>
<span id="cb32-531"><a href="#cb32-531" aria-hidden="true" tabindex="-1"></a>    sums.append(total)</span>
<span id="cb32-532"><a href="#cb32-532" aria-hidden="true" tabindex="-1"></a>    counts.append(count)</span>
<span id="cb32-533"><a href="#cb32-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-534"><a href="#cb32-534" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine intermediates to get total mean-delay-per-origin</span></span>
<span id="cb32-535"><a href="#cb32-535" aria-hidden="true" tabindex="-1"></a>total_delays <span class="op">=</span> <span class="bu">sum</span>(sums)</span>
<span id="cb32-536"><a href="#cb32-536" aria-hidden="true" tabindex="-1"></a>n_flights <span class="op">=</span> <span class="bu">sum</span>(counts)</span>
<span id="cb32-537"><a href="#cb32-537" aria-hidden="true" tabindex="-1"></a>mean <span class="op">=</span> total_delays <span class="op">/</span> n_flights</span>
<span id="cb32-538"><a href="#cb32-538" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-539"><a href="#cb32-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-542"><a href="#cb32-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-543"><a href="#cb32-543" aria-hidden="true" tabindex="-1"></a>mean</span>
<span id="cb32-544"><a href="#cb32-544" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-545"><a href="#cb32-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-546"><a href="#cb32-546" aria-hidden="true" tabindex="-1"></a><span class="fu">### Parallelize the code above</span></span>
<span id="cb32-547"><a href="#cb32-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-548"><a href="#cb32-548" aria-hidden="true" tabindex="-1"></a>Use <span class="in">`dask.delayed`</span> to parallelize the code above.  Some extra things you will need to know.</span>
<span id="cb32-549"><a href="#cb32-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-550"><a href="#cb32-550" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Methods and attribute access on delayed objects work automatically, so if you have a delayed object you can perform normal arithmetic, slicing, and method calls on it and it will produce the correct delayed calls.</span>
<span id="cb32-551"><a href="#cb32-551" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-552"><a href="#cb32-552" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Calling the <span class="in">`.compute()`</span> method works well when you have a single output.  When you have multiple outputs you might want to use the <span class="in">`dask.compute`</span> function. This way Dask can share the intermediate values.</span>
<span id="cb32-553"><a href="#cb32-553" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-554"><a href="#cb32-554" aria-hidden="true" tabindex="-1"></a>So your goal is to parallelize the code above (which has been copied below) using <span class="in">`dask.delayed`</span>.  You may also want to visualize a bit of the computation to see if you're doing it correctly.</span>
<span id="cb32-555"><a href="#cb32-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-556"><a href="#cb32-556" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb32-557"><a href="#cb32-557" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-558"><a href="#cb32-558" aria-hidden="true" tabindex="-1"></a><span class="co"># your code here</span></span>
<span id="cb32-559"><a href="#cb32-559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-560"><a href="#cb32-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-563"><a href="#cb32-563" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-564"><a href="#cb32-564" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-565"><a href="#cb32-565" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-566"><a href="#cb32-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-567"><a href="#cb32-567" aria-hidden="true" tabindex="-1"></a><span class="co"># This is just one possible solution, there are</span></span>
<span id="cb32-568"><a href="#cb32-568" aria-hidden="true" tabindex="-1"></a><span class="co"># several ways to do this using `dask.delayed`</span></span>
<span id="cb32-569"><a href="#cb32-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-570"><a href="#cb32-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-571"><a href="#cb32-571" aria-hidden="true" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb32-572"><a href="#cb32-572" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_file(filename):</span>
<span id="cb32-573"><a href="#cb32-573" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read in file</span></span>
<span id="cb32-574"><a href="#cb32-574" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_csv(filename)</span>
<span id="cb32-575"><a href="#cb32-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-576"><a href="#cb32-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-577"><a href="#cb32-577" aria-hidden="true" tabindex="-1"></a>sums <span class="op">=</span> []</span>
<span id="cb32-578"><a href="#cb32-578" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> []</span>
<span id="cb32-579"><a href="#cb32-579" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fn <span class="kw">in</span> filenames:</span>
<span id="cb32-580"><a href="#cb32-580" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Delayed read in file</span></span>
<span id="cb32-581"><a href="#cb32-581" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> read_file(fn)</span>
<span id="cb32-582"><a href="#cb32-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-583"><a href="#cb32-583" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Groupby origin airport</span></span>
<span id="cb32-584"><a href="#cb32-584" aria-hidden="true" tabindex="-1"></a>    by_origin <span class="op">=</span> df.groupby(<span class="st">"Origin"</span>)</span>
<span id="cb32-585"><a href="#cb32-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-586"><a href="#cb32-586" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sum of all departure delays by origin</span></span>
<span id="cb32-587"><a href="#cb32-587" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> by_origin.DepDelay.<span class="bu">sum</span>()</span>
<span id="cb32-588"><a href="#cb32-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-589"><a href="#cb32-589" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of flights by origin</span></span>
<span id="cb32-590"><a href="#cb32-590" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> by_origin.DepDelay.count()</span>
<span id="cb32-591"><a href="#cb32-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-592"><a href="#cb32-592" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the intermediates</span></span>
<span id="cb32-593"><a href="#cb32-593" aria-hidden="true" tabindex="-1"></a>    sums.append(total)</span>
<span id="cb32-594"><a href="#cb32-594" aria-hidden="true" tabindex="-1"></a>    counts.append(count)</span>
<span id="cb32-595"><a href="#cb32-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-596"><a href="#cb32-596" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine intermediates to get total mean-delay-per-origin</span></span>
<span id="cb32-597"><a href="#cb32-597" aria-hidden="true" tabindex="-1"></a>total_delays <span class="op">=</span> <span class="bu">sum</span>(sums)</span>
<span id="cb32-598"><a href="#cb32-598" aria-hidden="true" tabindex="-1"></a>n_flights <span class="op">=</span> <span class="bu">sum</span>(counts)</span>
<span id="cb32-599"><a href="#cb32-599" aria-hidden="true" tabindex="-1"></a>mean, <span class="op">*</span>_ <span class="op">=</span> dask.compute(total_delays <span class="op">/</span> n_flights)</span>
<span id="cb32-600"><a href="#cb32-600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-601"><a href="#cb32-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-604"><a href="#cb32-604" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-605"><a href="#cb32-605" aria-hidden="true" tabindex="-1"></a><span class="co"># ensure the results still match</span></span>
<span id="cb32-606"><a href="#cb32-606" aria-hidden="true" tabindex="-1"></a>mean</span>
<span id="cb32-607"><a href="#cb32-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-608"><a href="#cb32-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-609"><a href="#cb32-609" aria-hidden="true" tabindex="-1"></a><span class="fu">### Some questions to consider:</span></span>
<span id="cb32-610"><a href="#cb32-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-611"><a href="#cb32-611" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How much speedup did you get? Is this how much speedup you'd expect?</span>
<span id="cb32-612"><a href="#cb32-612" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Experiment with where to call <span class="in">`compute`</span>. What happens when you call it on <span class="in">`sums`</span> and <span class="in">`counts`</span>? What happens if you wait and call it on <span class="in">`mean`</span>?</span>
<span id="cb32-613"><a href="#cb32-613" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Experiment with delaying the call to <span class="in">`sum`</span>. What does the graph look like if <span class="in">`sum`</span> is delayed? What does the graph look like if it isn't?</span>
<span id="cb32-614"><a href="#cb32-614" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Can you think of any reason why you'd want to do the reduction one way over the other?</span>
<span id="cb32-615"><a href="#cb32-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-616"><a href="#cb32-616" aria-hidden="true" tabindex="-1"></a><span class="fu">### Learn More</span></span>
<span id="cb32-617"><a href="#cb32-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-618"><a href="#cb32-618" aria-hidden="true" tabindex="-1"></a>Visit the <span class="co">[</span><span class="ot">Delayed documentation</span><span class="co">](https://docs.dask.org/en/latest/delayed.html)</span>. In particular, this <span class="co">[</span><span class="ot">delayed screencast</span><span class="co">](https://www.youtube.com/watch?v=SHqFmynRxVU)</span> will reinforce the concepts you learned here and the <span class="co">[</span><span class="ot">delayed best practices</span><span class="co">](https://docs.dask.org/en/latest/delayed-best-practices.html)</span> document collects advice on using <span class="in">`dask.delayed`</span> well.</span>
<span id="cb32-619"><a href="#cb32-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-620"><a href="#cb32-620" aria-hidden="true" tabindex="-1"></a>Some improvements by actual parallelization of file reading, but we’re limited by IO throughput.</span>
<span id="cb32-621"><a href="#cb32-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-624"><a href="#cb32-624" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-625"><a href="#cb32-625" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-626"><a href="#cb32-626" aria-hidden="true" tabindex="-1"></a>dask.compute(sums)</span>
<span id="cb32-627"><a href="#cb32-627" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-628"><a href="#cb32-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-631"><a href="#cb32-631" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-632"><a href="#cb32-632" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-633"><a href="#cb32-633" aria-hidden="true" tabindex="-1"></a>dask.compute(counts)</span>
<span id="cb32-634"><a href="#cb32-634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-635"><a href="#cb32-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-638"><a href="#cb32-638" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-639"><a href="#cb32-639" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-640"><a href="#cb32-640" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-641"><a href="#cb32-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-642"><a href="#cb32-642" aria-hidden="true" tabindex="-1"></a><span class="co"># This is just one possible solution, there are</span></span>
<span id="cb32-643"><a href="#cb32-643" aria-hidden="true" tabindex="-1"></a><span class="co"># several ways to do this using `dask.delayed`</span></span>
<span id="cb32-644"><a href="#cb32-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-645"><a href="#cb32-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-646"><a href="#cb32-646" aria-hidden="true" tabindex="-1"></a><span class="at">@dask.delayed</span></span>
<span id="cb32-647"><a href="#cb32-647" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_file(filename):</span>
<span id="cb32-648"><a href="#cb32-648" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read in file</span></span>
<span id="cb32-649"><a href="#cb32-649" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_csv(filename)</span>
<span id="cb32-650"><a href="#cb32-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-651"><a href="#cb32-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-652"><a href="#cb32-652" aria-hidden="true" tabindex="-1"></a>sums <span class="op">=</span> []</span>
<span id="cb32-653"><a href="#cb32-653" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> []</span>
<span id="cb32-654"><a href="#cb32-654" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fn <span class="kw">in</span> filenames:</span>
<span id="cb32-655"><a href="#cb32-655" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Delayed read in file</span></span>
<span id="cb32-656"><a href="#cb32-656" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> read_file(fn)</span>
<span id="cb32-657"><a href="#cb32-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-658"><a href="#cb32-658" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Groupby origin airport</span></span>
<span id="cb32-659"><a href="#cb32-659" aria-hidden="true" tabindex="-1"></a>    by_origin <span class="op">=</span> df.groupby(<span class="st">"Origin"</span>)</span>
<span id="cb32-660"><a href="#cb32-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-661"><a href="#cb32-661" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sum of all departure delays by origin</span></span>
<span id="cb32-662"><a href="#cb32-662" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> by_origin.DepDelay.<span class="bu">sum</span>()</span>
<span id="cb32-663"><a href="#cb32-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-664"><a href="#cb32-664" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of flights by origin</span></span>
<span id="cb32-665"><a href="#cb32-665" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> by_origin.DepDelay.count()</span>
<span id="cb32-666"><a href="#cb32-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-667"><a href="#cb32-667" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the intermediates</span></span>
<span id="cb32-668"><a href="#cb32-668" aria-hidden="true" tabindex="-1"></a>    sums.append(total)</span>
<span id="cb32-669"><a href="#cb32-669" aria-hidden="true" tabindex="-1"></a>    counts.append(count)</span>
<span id="cb32-670"><a href="#cb32-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-671"><a href="#cb32-671" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine intermediates to get total mean-delay-per-origin</span></span>
<span id="cb32-672"><a href="#cb32-672" aria-hidden="true" tabindex="-1"></a>total_delays <span class="op">=</span> dask.delayed(<span class="bu">sum</span>)(sums)</span>
<span id="cb32-673"><a href="#cb32-673" aria-hidden="true" tabindex="-1"></a>n_flights <span class="op">=</span> dask.delayed(<span class="bu">sum</span>)(counts)</span>
<span id="cb32-674"><a href="#cb32-674" aria-hidden="true" tabindex="-1"></a>mean, <span class="op">*</span>_ <span class="op">=</span> dask.compute(total_delays <span class="op">/</span> n_flights)</span>
<span id="cb32-675"><a href="#cb32-675" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-676"><a href="#cb32-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-679"><a href="#cb32-679" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-680"><a href="#cb32-680" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-681"><a href="#cb32-681" aria-hidden="true" tabindex="-1"></a>dask.delayed(<span class="bu">sum</span>)(sums).visualize()</span>
<span id="cb32-682"><a href="#cb32-682" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-683"><a href="#cb32-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-686"><a href="#cb32-686" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-687"><a href="#cb32-687" aria-hidden="true" tabindex="-1"></a><span class="co">#| tags: [solution]</span></span>
<span id="cb32-688"><a href="#cb32-688" aria-hidden="true" tabindex="-1"></a><span class="bu">sum</span>(sums).visualize()</span>
<span id="cb32-689"><a href="#cb32-689" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-690"><a href="#cb32-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-691"><a href="#cb32-691" aria-hidden="true" tabindex="-1"></a>:::solution</span>
<span id="cb32-692"><a href="#cb32-692" aria-hidden="true" tabindex="-1"></a>Delaying the sum could be interesting in case to make more balanced loads between tasks.</span>
<span id="cb32-693"><a href="#cb32-693" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-694"><a href="#cb32-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-695"><a href="#cb32-695" aria-hidden="true" tabindex="-1"></a><span class="fu">## Close the Client</span></span>
<span id="cb32-696"><a href="#cb32-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-697"><a href="#cb32-697" aria-hidden="true" tabindex="-1"></a>Before moving on to the next exercise, make sure to close your client or stop this kernel.</span>
<span id="cb32-698"><a href="#cb32-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-701"><a href="#cb32-701" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb32-702"><a href="#cb32-702" aria-hidden="true" tabindex="-1"></a>client.close()</span>
<span id="cb32-703"><a href="#cb32-703" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>